<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link rel="stylesheet" type="text/css" href="css/button.css">
    <link rel="stylesheet" type="text/css" href="css/listitem.css">
    <link rel="stylesheet" type="text/css" href="css/headings.css">
    <link rel="stylesheet" type="text/css" href="css/modal.css">
    <link rel="stylesheet" type="text/css" href="css/link.css">
    <link rel="stylesheet" type="text/css" href="css/id.css">
    <link rel="stylesheet" type="text/css" href="css/table_th_td_tr.css">
    <link rel="stylesheet" type="text/css" href="css/form.css">
    <link rel="stylesheet" type="text/css" href="css/search.css">
    <link rel="stylesheet" type="text/css" href="css/dragging.css">
    <link rel="stylesheet" type="text/css" href="css/w3style.css">
    <title>Document</title>
</head>
<body>
    <div class="box w3-bar-block w3-collapse w3-large w3-theme-l5" style="height: auto; padding:0vw; display:flex;">
    <div class="image-container">
        <a href='/' style="display: inline-block;" title="В корневую директорию"><img src="/images/MNS_logo.png" class=logo  alt="Лого не прогрузилось"></a>
    </div>
    <ul class="w3-ul sizeAble" id="dir_tree">
    </ul>
    </div>
    </div>
    <div class="box" id="center">
    <button id="back">Back</button>
    <ul id="center_list"></ul>
    </div>
    <div class="box" id="rightPanel"></div>
    <script>
        let currentPath = '/';
        const list = document.getElementById('dir_tree');
        const center = document.getElementById('center_list');

        const liToUl = (liElement) => {
            if (liElement.tagName === 'LI') {
                const ulElement = document.createElement('ul');
                ulElement.textContent = liElement.textContent;
                liElement.insertAdjacentElement('afterend', ulElement);
                return ulElement;
            }
        };
        
        const getAddictivePath = (element, addictivePath = '') => {
            if (element.parentNode && element.parentNode.classList.contains('directory')) {
                addictivePath += element.parentNode.innerHTML.substring(0, element.parentNode.innerHTML.indexOf('<')) + '/';
                getAddictivePath(element.parentNode, addictivePath);
                console.log(element.parentNode, addictivePath);
            } 
            return addictivePath;
        }


        const listOnContextMenu = (el, e) => {
            e.preventDefault();
            if (!currentPath.endsWith('/')) {
                currentPath += '/';
            }
            currentPath = currentPath + el.textContent;
            console.log(currentPath);
            try {
                fetchData(currentPath)
                .then(data => {
                    // Используйте данные
                    updateList(list, data);
                })
                .catch(error => {
                    // Обработка ошибки
                    console.error(error);
                });
                // Дальнейшая обработка newData, если необходимо
            } catch (error) {
                console.error('Произошла ошибка при fetchData:', error);
            }
        }

        const listOnMouseDown = (el, e) => {
            if (!currentPath.endsWith('/')) {
                currentPath += '/';
            }
            const addictivePath = getAddictivePath(el);
            console.log(addictivePath);
            fetchData(currentPath + addictivePath + el.textContent)
            .then(data => {
                // Используйте данные
                clearList(center);
                const newlist = addList(el);
                if (newlist) {
                    const ul = liToUl(el);
                    if (ul) {
                        ul.classList.add('directory');
                        fillList(ul, data);
                        linkElements(ul);
                        el.remove();
                    }
                }
                currentPath = currentPath.substring(0, currentPath.lastIndexOf('/')); // обрезаем добавленный слеш
            })
        } 

        const clearList = (list) => {
            list.innerHTML = ''; // Очищаем текущее содержимое
        }

        const fillList = (list, data) => {
            data.forEach(item => {
                const listItem = document.createElement('li');
                listItem.textContent = item.name; // Предположим, что item - это текстовое содержимое элемента
                listItem.classList.add(item.type);
                list.appendChild(listItem);
            });
        }

        const addList = (parent) => {
            if (parent.nextElementSibling && parent.nextElementSibling.tagName === 'UL') {
                return;
            }
            const ul = document.createElement('ul');
            parent.appendChild(ul);
            return ul;
        }

        const linkElements = (list) => {
            list.querySelectorAll('.directory').forEach(el => {
                el.addEventListener('contextmenu', async (e) => {
                    listOnContextMenu(el, e);
                });

                el.addEventListener('mousedown', (e) => {
                    listOnMouseDown(el, e);
                });
            });
        }

        const updateList = (list, data) => {
            clearList(list);
            fillList(list, data);
            linkElements(list);
        }

        const fetchData = (path) => {
            return new Promise((resolve, reject) => {
                fetch('/get-dir-info', {
                    method: "POST",
                    headers: { "Content-type": "application/json" },
                    body: JSON.stringify({ path: path })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка запроса');
                    }
                    return response.json();
                })
                .then(async data => {
                    resolve(data); // Возвращаем данные через resolve
                })
                .catch(error => {
                    console.error('Произошла ошибка:', error);
                    reject(error); // Возвращаем ошибку через reject
                });
            });
        };

        document.getElementById('back').addEventListener('click', (event) => {
            currentPath = currentPath.substring(0, currentPath.lastIndexOf('/'));
            console.log(currentPath);
            fetchData(currentPath)
            .then(data => {
                updateList(list, data);
            })
        })

        // Пример использования
        fetchData('/')
            .then(data => {
                // Используйте данные
                updateList(list, data);
            })
            .catch(error => {
                // Обработка ошибки
                console.error(error);
            });
    </script>
    
</body>
</html>